---
title: "Liability threshold and time-to-event models"
author: "Advanced Topics in Genomics - Week 39"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
setwd("../liability_threshold_models/")
```

## Prerequisites
There are several requirements for completing this exercise.

1.  R studio with R version \>3.3.
2.  R package survival. For most users executing the `install.packages("survival")` ensures this.

```{r, echo = FALSE}
library(survival)
```

## Exercises

In these exercises, we will work on the concepts of the liability threshold model and time-to-event (survival) analysis.

We will:
 
 - Simulate genetic data under the liability threshold model
 
 - Estimate heritability from data with both genetic and environmental contributions
 
 - Explore the impact of ascertainment bias

 - Perform survival analysis to account for left and right censoring of data  

<br>

#### Part 1: Simulating data under the liability threshold model

The liability threshold model assumes that each individual has an underlying liability, which follows a normal distribution. Only individuals whose liability exceeds a certain threshold are considered cases.

```{r}

# Parameters
n_individuals <- 10000    # Number of individuals
n_snps <- 1000            # Number of SNPs that contribute to an individuals liability
maf <- 0.3                # Minor allele frequency
heritability <- 0.5       # Heritability of liability
threshold <- qnorm(0.95)  # Threshold 

# Simulate genotypes
set.seed(123)
genotypes <- matrix(rbinom(n_individuals * n_snps, 2, maf), nrow = n_individuals, ncol = n_snps)

# Simulate SNP effects
beta <- rnorm(n_snps, mean = 0, sd = sqrt(heritability / n_snps))

# Calculate liability
genetic_liability <- genotypes %*% beta

# Classify individuals as cases or controls based on threshold
phenotype <- ifelse(genetic_liability > threshold, 1, 0)

# Visualize the distribution of liability
hist(genetic_liability, main = "Genetic Liability Distribution", xlab = "Liability", xlim = c(-3, 3), breaks = 30, col = "lightblue")
abline(v = threshold, col = "red", lwd = 2)

# Print the number of cases
table(phenotype)


```
##### Q1: Look at the genotype matrix. What does 0, 1, 2 designate?
##### A1: 0 alternate alleles, 1 alternate allele, 2 alternate alles. MAF is used as the probability of having the minor allele.

##### Q2: What does the threshold `threshold <- qnorm(0.95) ` indicate?
##### A2: A population prevalence of 5%

##### Q3: Look at line 56 in the code. How are the SNP effect sizes calculated and what assumption is it based on?
##### A3: The effect sizes are drawn from a normal distribution with mean 0 and a standard deviation proportional to the heritability. It assumes that each SNP contributes equally to the genetic liability.

DELETE:
The rest of the code:

Line 59: 
genotypes %*% beta: This computes the genetic liability for each individual by taking a weighted sum of the individual's genotypes, with weights given by the SNP effect sizes (beta).

genetic_liability <- numeric(n_individuals)
for (i in 1:n_individuals) {
  genetic_liability[i] <- sum(genotypes[i, ] * beta)
}

rnorm(n_individuals, mean = 0, sd = sqrt(1 - heritability)): This adds an environmental noise component to the liability, which has variance 1 - heritability to ensure that the total variance is 1. This noise represents non-genetic factors influencing liability.

<br>

#### Part 2: Liability with an environmental component

We will now add an environmental component to the liability model to reflect the influence of non-genetic factors. This allows us to model a more realistic scenario where liability is influenced by both genetic and environmental factors.

```{r}
# Add environmental noise to the genetic liability
total_liability <- genetic_liability + rnorm(n_individuals, mean = 0, sd = sqrt(1 - heritability))

# Classify based on threshold
phenotype_env <- ifelse(total_liability > threshold, 1, 0)

# Visualize liability with environmental effects
hist(total_liability, main = "Liability with Environmental Component", xlab = "Liability", xlim = c(-3, 3), breaks = 30, col = "lightgreen")
abline(v = threshold, col = "red", lwd = 2)

table(phenotype_env)

```
##### Q4: How have we modeled environmental variance in the code above?
##### A4: As random noise, independent of the genetic factors, and its variance is determined by the proportion of variance not explained by genetics (i.e., 1 âˆ’ heritability).

##### Q5: How does adding environmental noise affect the liability distribution? How does it influence the classification of individuals as cases or controls?
##### A5: The overall variance of the liability increases when environmental noise is added. As a result, the liability distribution becomes wider and more individuals will have extreme liability scores because the random environmental effects can push their total liability further from the mean. This results in more individuals exceeding the threshold

<br>

We can now estimate the heritability as the ratio of genetic variance to total variance.
```{r}

var_genetic <- var(genetic_liability)
var_total <- var(total_liability)

heritability_est <- var_genetic / var_total
heritability_est


```
##### Q6: Compare the estimated heritability with the true value used in the simulation. What factors might cause these values to differ?
##### A6: Even in a simulated environment where the true heritability is known, the inherent randomness in the simulation process leads to variability in the estimated heritability. Factors like random sampling of genotypes, random drawing of SNP effect sizes and environmental noise, finite sample size (both individuals and SNPs), and the estimation method itself (the assumptions of the model) can cause the estimated heritability to differ from the true value. 

<br>

#### Part 3: Ascertainment bias

Ascertainment bias occurs when cases and controls are sampled in a biased manner, often leading to over-representation of certain groups. This can significantly distort effect size estimates and heritability. 

In this exercise, we will simulate ascertainment bias by oversampling cases and investigate how this bias alters the data.

```{r}
# Sample individuals with bias (e.g., oversample cases)
set.seed(123)
ascertained_cases <- sample(which(phenotype_env == 1), 5000, replace = TRUE)
ascertained_controls <- sample(which(phenotype_env == 0), 5000, replace = TRUE)
ascertained_sample <- c(ascertained_cases, ascertained_controls)

# Visualize the ascertained data
liability_ascertained <- total_liability[ascertained_sample]
phenotype_ascertained <- phenotype_env[ascertained_sample]

hist(liability_ascertained, main = "Ascertainment Bias in Sampled Data", xlab = "Liability", xlim = c(-3, 3), breaks = 30, col = "lightcoral")
abline(v = threshold, col = "red", lwd = 2)


```

##### Q7: How does ascertainment bias alter the distribution of liability in the sample compared to before?
##### A7: The distribution is no longer normal, which violates model assumptions

##### Q8: Reestimate the heritability. How has the estimate changed from before? Why?
```{r}

genetic_liability_ascertained <- genetic_liability[ascertained_sample]

var_genetic <- var(genetic_liability_ascertained)
var_total <- var(liability_ascertained)

heritability_est <- var_genetic / var_total
heritability_est
```


<br>

#### Part 4: Accounting for left and right censoring
Survival analysis models are designed to handle time-to-event data and can account for right and left censoring. In this exercise, you will simulate time-to-event data and perform survival analysis using the Cox proportional hazards model.

We simulate both the time to event and censoring times (e.g., time when an individual's data is no longer available). The Cox model will help us analyze how genetic factors affect the risk of experiencing the event.

```{r}

# Simulate survival times
set.seed(123)
time_to_event <- rexp(n_individuals, rate = exp(total_liability - mean(total_liability)))
censoring_time <- rexp(n_individuals, rate = 0.02) # Censoring time
observed_time <- pmin(time_to_event, censoring_time)
event <- ifelse(time_to_event <= censoring_time, 1, 0) # Event indicator

# Create survival object
surv_obj <- Surv(observed_time, event)

# Fit Cox proportional hazards model
cox_model <- coxph(surv_obj ~ genotypes[,1])
summary(cox_model)


```
##### Q9: How does the estimated hazard ratio from the Cox model help us understand the effect of genetics on the time to disease onset?
##### A9: The hazard ratio provides a measure of the relative risk of experiencing the event based on their genotypes

```{r}
km_fit <- survfit(surv_obj ~ phenotype_env, conf.type = "log-log")
plot(km_fit, col = c("blue", "red"), lty = 1:2, xlab = "Time", ylab = "Survival Probability", main = "Kaplan-Meier Curve by Phenotype")
legend("topright", legend = c("Control", "Case"), col = c("blue", "red"), lty = 1:2)

```

##### Q10: How does the survival curve differ between cases and controls? What does this tell you about disease risk over time?
##### A10: The survival curve for cases declines more rapidly, indicating that cases experience the event at a faster rate. This divergence reflects the underlying risk factors that differentiate cases from controls, offering insights into disease dynamics over time.

